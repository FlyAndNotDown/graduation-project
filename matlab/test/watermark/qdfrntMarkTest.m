% load image
source = im2double(imread('lena.bmp'));
secret = imread('secret4.bmp');

% calculate the kernel of DFRNT
% p = rand(8, 8);
% r = dfrntKernel(0.75, 1, p);
% ir = dfrntKernel(-0.75, 1, p);

% 0.983383	0.382419	0.855070	0.341293	0.165377	0.970792	0.237415	0.108817	
% 0.459783	0.584444	0.929658	0.120898	0.682566	0.876350	0.207102	0.435477	
% 0.250973	0.883481	0.510012	0.776253	0.138441	0.356974	0.891741	0.022061	
% 0.887123	0.941715	0.897816	0.719655	0.306916	0.287992	0.281940	0.303281	
% 0.908834	0.047613	0.703016	0.542535	0.010019	0.844106	0.494100	0.890066	
% 0.951182	0.883742	0.570596	0.001577	0.326265	0.633775	0.422001	0.226249	
% 0.280351	0.376561	0.837315	0.614140	0.338970	0.016352	0.577794	0.689683	
% 0.759837	0.375195	0.335687	0.442617	0.432487	0.322330	0.441003	0.294191
p = zeros(8, 8);
p(1, :) = [0.983383, 0.382419, 0.855070, 0.341293, 0.165377, 0.970792, 0.237415, 0.108817];
p(2, :) = [0.459783, 0.584444, 0.929658, 0.120898, 0.682566, 0.876350, 0.207102, 0.435477];
p(3, :) = [0.250973, 0.883481, 0.510012, 0.776253, 0.138441, 0.356974, 0.891741, 0.022061];
p(4, :) = [0.887123, 0.941715, 0.897816, 0.719655, 0.306916, 0.287992, 0.281940, 0.303281];
p(5, :) = [0.908834, 0.047613, 0.703016, 0.542535, 0.010019, 0.844106, 0.494100, 0.890066];
p(6, :) = [0.951182, 0.883742, 0.570596, 0.001577, 0.326265, 0.633775, 0.422001, 0.226249];
p(7, :) = [0.280351, 0.376561, 0.837315, 0.614140, 0.338970, 0.016352, 0.577794, 0.689683];
p(8, :) = [0.759837, 0.375195, 0.335687, 0.442617, 0.432487, 0.322330, 0.441003, 0.294191];
r = dfrntKernel(9.838433, 56, p);
ir = dfrntKernel(-9.838433, 56, p);

% watermarking
[output, kp] = qdfrntMark(source, secret, 3, r, ir, 13);

% calculate ssim
[ssimVal, ~] = ssim(source, output);

% restore
load('data/qdfrntModel.mat', 'model');
secretRestored = qdfrntRestore(output, model, kp, 3, r);
secretBer = ber(secret, secretRestored);

% show result
figure();
subplot(2, 2, 1);
imshow(source);
subplot(2, 2, 2);
imshow(secret);
subplot(2, 2, 3);
imshow(output);
subplot(2, 2, 4);
imshow(secretRestored);